<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Asignaciones para las reuniones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --card-bg: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --accent-strong: #facc15;
      --text: #f9fafb;
      --muted: #9ca3af;
      --border: rgba(148, 163, 184, 0.4);
      --radius-xl: 20px;
      --radius-md: 14px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.85);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at top, rgba(56, 189, 248, 0.25), transparent 55%),
        radial-gradient(circle at bottom, rgba(250, 204, 21, 0.18), transparent 55%),
        linear-gradient(135deg, #020617, #020617 40%, #020617);
      color: var(--text);
      padding: 1.5rem;
      display: flex;
      justify-content: center;
    }

    .page {
      width: 100%;
      max-width: 960px;
    }

    header {
      text-align: center;
      margin-bottom: 0.9rem;
    }

    header h1 {
      font-size: clamp(2.1rem, 5vw, 2.7rem);
      letter-spacing: 0.03em;
      font-weight: 700;
      color: #f9fafb;
      text-shadow: 0 0 22px rgba(15, 23, 42, 0.9);
      line-height: 1.15;
    }

    .pill-bar {
      display: inline-flex;
      align-items: center;
      gap: 0.55rem;
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.5);
      margin-top: 0.7rem;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 12px rgba(34, 197, 94, 0.9);
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
    }

    .month-selector {
      margin: 0.9rem auto 0.6rem;
      max-width: 360px;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      align-items: stretch;
    }

    .month-selector-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: var(--muted);
      text-align: left;
    }

    .month-selector select {
      width: 100%;
      padding: 0.45rem 0.8rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.96);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
      appearance: none;
      -moz-appearance: none;
      -webkit-appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, #9ca3af 50%),
        linear-gradient(135deg, #9ca3af 50%, transparent 50%);
      background-position:
        calc(100% - 15px) calc(50% - 3px),
        calc(100% - 10px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    .card-shell {
      background: radial-gradient(circle at top left, rgba(148, 163, 184, 0.1), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(15, 23, 42, 0.95), #020617);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 1.25rem 1.1rem 1.35rem;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card-shell::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top right, rgba(56, 189, 248, 0.15), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }

    .card-shell-inner {
      position: relative;
      z-index: 1;
    }

    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.6rem;
      gap: 0.75rem;
    }

    .section-title h2 {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: var(--muted);
      font-weight: 600;
    }

    .section-title span {
      font-size: 0.9rem;
      color: var(--muted);
      padding: 0.15rem 0.9rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.95);
      white-space: nowrap;
    }

    .assignments-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 1rem;
      max-height: calc(100vh - 230px);
      overflow-y: auto;
      padding-right: 0.35rem;
    }

    .assignments-grid::-webkit-scrollbar {
      width: 6px;
    }

    .assignments-grid::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.7);
      border-radius: 999px;
    }

    .assignments-grid::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.9);
      border-radius: 999px;
    }

    .assignment-card {
      background: radial-gradient(circle at top left, rgba(15, 23, 42, 0.96), rgba(15, 23, 42, 0.99));
      border-radius: var(--radius-md);
      border: 1px solid rgba(148, 163, 184, 0.5);
      padding: 0.85rem 0.8rem 0.8rem;
      display: grid;
      grid-template-columns: minmax(0, 1.25fr) minmax(0, 2.1fr);
      gap: 0.4rem 1.1rem;
      position: relative;
    }

    /* tarjeta destacada (próxima reunión) - fija arriba al hacer scroll */
    .assignment-card.destacada {
      border-color: rgba(56, 189, 248, 0.9);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
      position: sticky;
      top: 0;
      z-index: 2;
    }

    .assignment-date {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      font-size: 0.95rem;
    }

    .assignment-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: var(--muted);
    }

    .assignment-day {
      font-size: 1.05rem;
      font-weight: 700;
      color: #f9fafb;
    }

    .assignment-day.church-day {
      color: var(--accent-strong);
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-top: 0.25rem;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.8rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.78rem;
      color: var(--muted);
      width: fit-content;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.9);
    }

    .badge-hoy {
      border-color: #22c55e;
      color: #bbf7d0;
      background: rgba(22, 163, 74, 0.22);
    }

    .badge-hoy .badge-dot {
      background: #22c55e;
      box-shadow: 0 0 12px rgba(22, 163, 74, 0.9);
    }

    .assignment-details {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 0.3rem 0.9rem;
      font-size: 0.9rem;
    }

    .detail-group {
      display: flex;
      flex-direction: column;
      gap: 0.05rem;
    }

    .detail-label {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.13em;
      color: var(--muted);
      position: relative;
      padding-left: 1rem;
    }

    .detail-label::before {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--muted);
    }

    .detail-label.label-audio::before {
      background: #38bdf8;
    }

    .detail-label.label-video::before {
      background: #a78bfa;
    }

    .detail-label.label-mic::before {
      background: #4ade80;
    }

    .detail-label.label-plataforma::before {
      background: #facc15;
    }

    .detail-label.label-entrada::before {
      background: #fb923c;
    }

    .detail-label.label-auditorio::before {
      background: #fb7185;
    }

    .detail-value {
      font-size: 0.96rem;
      color: #e5e7eb;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .empty-msg {
      font-size: 0.95rem;
      color: var(--muted);
      padding-top: 0.5rem;
    }

    /* Ajustes generales para pantallas medianas (tablet, etc.) */
    @media (max-width: 900px) {
      body {
        padding: 1rem 0.7rem 1.2rem;
      }
    }

    /* Ajustes especiales para celular */
    @media (max-width: 640px) {
      body {
        padding: 0.8rem 0.4rem 1.2rem;
      }

      header h1 {
        font-size: 1.7rem;
        line-height: 1.2;
      }

      .card-shell {
        padding: 0.9rem 0.8rem 1rem;
      }

      .assignments-grid {
        max-height: none;
        overflow-y: visible;
        padding-right: 0;
      }

      .assignment-card {
        grid-template-columns: minmax(0, 1fr);
        padding: 0.9rem 0.85rem;
      }

      .assignment-details {
        grid-template-columns: minmax(0, 1fr);
        row-gap: 0.35rem;
      }

      .assignment-day {
        font-size: 1.05rem;
      }

      .detail-label {
        font-size: 0.7rem;
      }

      .detail-value {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <main class="page">
    <header>
      <h1>Asignaciones para las reuniones</h1>

      <div class="pill-bar">
        <span class="pill-dot"></span>
        <span>Conectado a hoja de cálculo · Actualización automática</span>
      </div>
    </header>

    <!-- Selector de Mes / año -->
    <section class="month-selector">
      <span class="month-selector-label">Mes / año</span>
      <select id="monthYearSelect"></select>
    </section>

    <section class="layout">
      <section class="card-shell">
        <div class="card-shell-inner">
          <div class="section-title">
            <h2>Próximas reuniones</h2>
            <span id="count-resumen">Cargando…</span>
          </div>

          <div id="assignments" class="assignments-grid"></div>
        </div>
      </section>
    </section>
  </main>

  <script>
    // URL del CSV de tu hoja publicada
    const CSV_URL =
      "https://docs.google.com/spreadsheets/d/1v0ZUvpB5vE0_e8QL7ZdxXJOsvr6RTrIjBZcjRjdh44E/export?format=csv&gid=96081337";

    const NOMBRES_MESES = [
      "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
      "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];

    function parseCSV(text) {
      const rows = text.trim().split(/\r?\n/);
      return rows.map((row) => row.split(","));
    }

    function normalizarTexto(str) {
      return (str || "")
        .toString()
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/,/g, "")
        .trim();
    }

    // Convierte "Viernes 5 de diciembre 2025" (o sin año) en Date
function parseFechaTexto(fechaTexto) {
  const limpio = normalizarTexto(fechaTexto);
  if (!limpio) return null;

  const partes = limpio.split(" ").filter(Boolean);
  // Puede venir: ["viernes","5","de","diciembre"]
  // o:          ["viernes","5","de","diciembre","2025"]
  if (partes.length < 4) return null;

  const dia = parseInt(partes[1], 10);
  const mesNombre = partes[3];

  const meses = {
    enero: 0,
    febrero: 1,
    marzo: 2,
    abril: 3,
    mayo: 4,
    junio: 5,
    julio: 6,
    agosto: 7,
    septiembre: 8,
    setiembre: 8,
    octubre: 9,
    noviembre: 10,
    diciembre: 11
  };

  const mes = meses[mesNombre];
  if (isNaN(dia) || mes == null) return null;

  // Si viene año en el texto lo usamos; si no, usamos el año actual
  let year = new Date().getFullYear();
  if (partes.length >= 5) {
    const posibleYear = parseInt(partes[4], 10);
    if (!isNaN(posibleYear)) {
      year = posibleYear;
    }
  }

  return new Date(year, mes, dia);
}

    // Devuelve true si la fecha de la fila es "hoy"
    function esHoy(fechaTexto) {
      const fecha = parseFechaTexto(fechaTexto);
      if (!fecha) return false;
      const hoy = new Date();
      const soloHoy = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
      const soloFecha = new Date(fecha.getFullYear(), fecha.getMonth(), fecha.getDate());
      return soloFecha.getTime() === soloHoy.getTime();
    }

    // Marca domingos y sábados (para color amarillo del título)
    function esDiaImportante(fechaTexto) {
      const limpio = normalizarTexto(fechaTexto);
      return (
        limpio.startsWith("domingo") ||
        limpio.startsWith("sabado") ||
        limpio.startsWith("sábado")
      );
    }

    async function cargarCartelera() {
      const resumen = document.getElementById("count-resumen");
      const contenedor = document.getElementById("assignments");
      const selectorMes = document.getElementById("monthYearSelect");

      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        const data = parseCSV(text);

        if (!data || data.length < 2) {
          resumen.textContent = "0 reuniones";
          contenedor.innerHTML =
            "<p class='empty-msg'>Sin asignaciones cargadas.</p>";
          return;
        }

        // filas de datos (saltamos encabezados)
        const filas = data
          .slice(1)
          .filter((row) => row.some((cell) => cell && cell.trim() !== ""));

        // Preparamos estructura con fecha real (para poder separar meses)
        const asignaciones = filas.map((row) => {
          const fechaTexto = row[0] || "";
          const fecha = parseFechaTexto(fechaTexto);
          let year = null;
          let month = null;
          if (fecha) {
            year = fecha.getFullYear();
            month = fecha.getMonth();
          }
          return { row, fechaTexto, fecha, year, month };
        });

        // Si no hay ninguna fecha válida
        if (asignaciones.length === 0) {
          resumen.textContent = "0 reuniones";
          contenedor.innerHTML =
            "<p class='empty-msg'>Sin asignaciones cargadas.</p>";
          return;
        }

        // Construir lista de meses/años disponibles
        const mesesMap = new Map();
        asignaciones.forEach((a) => {
          if (!a.fecha) return;
          const key = `${a.year}-${a.month}`;
          if (!mesesMap.has(key)) {
            mesesMap.set(key, { year: a.year, month: a.month });
          }
        });

        const mesesDisponibles = Array.from(mesesMap.values()).sort((a, b) => {
          if (a.year !== b.year) return a.year - b.year;
          return a.month - b.month;
        });

        // Popular el select
        selectorMes.innerHTML = "";
        mesesDisponibles.forEach((m) => {
          const opt = document.createElement("option");
          opt.value = `${m.year}-${m.month}`;
          opt.textContent = `${NOMBRES_MESES[m.month]} ${m.year}`;
          selectorMes.appendChild(opt);
        });

        // Seleccionar por defecto el mes actual si existe, si no el primero
        const hoy = new Date();
        const claveHoy = `${hoy.getFullYear()}-${hoy.getMonth()}`;
        let valorPorDefecto = selectorMes.options[0].value;
        for (const m of mesesDisponibles) {
          const key = `${m.year}-${m.month}`;
          if (key === claveHoy) {
            valorPorDefecto = key;
            break;
          }
        }
        selectorMes.value = valorPorDefecto;

        function renderizar() {
          const value = selectorMes.value;
          const [yearStr, monthStr] = value.split("-");
          const selYear = parseInt(yearStr, 10);
          const selMonth = parseInt(monthStr, 10);

          // Filtrar asignaciones por mes/año seleccionado
          const asignacionesMes = asignaciones.filter(
            (a) => a.fecha && a.year === selYear && a.month === selMonth
          );

          if (asignacionesMes.length === 0) {
            resumen.textContent = "0 reuniones";
            contenedor.innerHTML =
              "<p class='empty-msg'>Sin asignaciones para este mes.</p>";
            return;
          }

          const hoy = new Date();
          const hoySolo = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

          const futurasOHoy = [];
          const pasadas = [];

          asignacionesMes.forEach((a) => {
            if (!a.fecha) {
              futurasOHoy.push({ row: a.row, fecha: null });
              return;
            }
            const soloFecha = new Date(
              a.fecha.getFullYear(),
              a.fecha.getMonth(),
              a.fecha.getDate()
            );
            if (soloFecha.getTime() < hoySolo.getTime()) {
              pasadas.push({ row: a.row, fecha: soloFecha });
            } else {
              futurasOHoy.push({ row: a.row, fecha: soloFecha });
            }
          });

          futurasOHoy.sort((a, b) => {
            if (!a.fecha && !b.fecha) return 0;
            if (!a.fecha) return 1;
            if (!b.fecha) return -1;
            return a.fecha - b.fecha;
          });
          pasadas.sort((a, b) => {
            if (!a.fecha && !b.fecha) return 0;
            if (!a.fecha) return 1;
            if (!b.fecha) return -1;
            return a.fecha - b.fecha;
          });

          // Solo mostramos las reuniones de hoy y futuras
const filasOrdenadas = futurasOHoy;

          contenedor.innerHTML = "";

          const total = filasOrdenadas.length;

if (total === 0) {
  resumen.textContent = "0 reuniones asignadas";
  contenedor.innerHTML = "<p class='empty-msg'>No hay reuniones futuras en este mes.</p>";
  return;
}

resumen.textContent =
  total === 1 ? "1 reunión asignada" : total + " reuniones asignadas";

          filasOrdenadas.forEach((item, index) => {
            const row = item.row;

            // columnas según tu hoja:
            // 0: Fecha
            // 1: Video
            // 2: Audio
            // 3: Mic 1
            // 4: Mic 2
            // 5: Plataforma
            // 6: Acomodador de Entrada
            // 7: Acomodador de Auditorio
            const fechaTexto = row[0] || "";
            const video = row[1] || "";
            const audio = row[2] || "";
            const mic1 = row[3] || "";
            const mic2 = row[4] || "";
            const plataforma = row[5] || "";
            const acomodadorEntrada = row[6] || "";
            const acomodadorAuditorio = row[7] || "";

            const card = document.createElement("article");
            card.className = "assignment-card";

            const esPrimeraFutura = index === 0; // próxima reunión dentro de este mes
            const esDiaHoy = esHoy(fechaTexto);

            if (esPrimeraFutura) {
              card.classList.add("destacada");
            }

            // columna izquierda: fecha + badges
            const fechaDiv = document.createElement("div");
            fechaDiv.className = "assignment-date";

            const labelSpan = document.createElement("span");
            labelSpan.className = "assignment-label";
            labelSpan.textContent = esPrimeraFutura ? "Próxima reunión" : "Reunión";

            const daySpan = document.createElement("span");
            daySpan.className = "assignment-day";
            if (esDiaImportante(fechaTexto)) {
              daySpan.classList.add("church-day");
            }
            daySpan.textContent = fechaTexto;

            const badgesRow = document.createElement("div");
            badgesRow.className = "badge-row";

            const badgeTipo = document.createElement("div");
            badgeTipo.className = "badge";
            const dotTipo = document.createElement("span");
            dotTipo.className = "badge-dot";
            const txtTipo = document.createElement("span");
            txtTipo.textContent = esDiaImportante(fechaTexto)
              ? "Reunión principal"
              : "Reunión de entre semana";
            badgeTipo.appendChild(dotTipo);
            badgeTipo.appendChild(txtTipo);
            badgesRow.appendChild(badgeTipo);

            if (esDiaHoy) {
              const badgeHoy = document.createElement("div");
              badgeHoy.className = "badge badge-hoy";
              const dotHoy = document.createElement("span");
              dotHoy.className = "badge-dot";
              const txtHoy = document.createElement("span");
              txtHoy.textContent = "HOY TE TOCA";
              badgeHoy.appendChild(dotHoy);
              badgeHoy.appendChild(txtHoy);
              badgesRow.appendChild(badgeHoy);
            }

            fechaDiv.appendChild(labelSpan);
            fechaDiv.appendChild(daySpan);
            fechaDiv.appendChild(badgesRow);

            // columna derecha: detalles
            const detallesDiv = document.createElement("div");
            detallesDiv.className = "assignment-details";

            function crearGrupo(label, value, extraClass) {
              const group = document.createElement("div");
              group.className = "detail-group";

              const l = document.createElement("div");
              l.className = "detail-label";
              if (extraClass) l.classList.add(extraClass);
              l.textContent = label;

              const v = document.createElement("div");
              v.className = "detail-value";
              v.textContent = value || "-";

              group.appendChild(l);
              group.appendChild(v);
              return group;
            }

            detallesDiv.appendChild(crearGrupo("Audio", audio, "label-audio"));
            detallesDiv.appendChild(crearGrupo("Video", video, "label-video"));
            detallesDiv.appendChild(crearGrupo("Mic 1", mic1, "label-mic"));
            detallesDiv.appendChild(crearGrupo("Mic 2", mic2, "label-mic"));
            detallesDiv.appendChild(
              crearGrupo("Plataforma", plataforma, "label-plataforma")
            );
            detallesDiv.appendChild(
              crearGrupo("Acomodador entrada", acomodadorEntrada, "label-entrada")
            );
            detallesDiv.appendChild(
              crearGrupo("Acomodador auditorio", acomodadorAuditorio, "label-auditorio")
            );

            card.appendChild(fechaDiv);
            card.appendChild(detallesDiv);
            contenedor.appendChild(card);
          });
        }

        // Primera renderización
        renderizar();

        // Al cambiar de mes en el selector
        selectorMes.addEventListener("change", renderizar);
      } catch (err) {
        console.error("Error cargando la cartelera:", err);
        resumen.textContent = "Error al cargar";
        contenedor.innerHTML =
          "<p class='empty-msg'>Hubo un error al cargar las asignaciones.</p>";
      }
    }

    cargarCartelera();
  </script>
</body>
</html>